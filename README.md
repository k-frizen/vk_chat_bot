Данный чат-бот был создан для информирования и продажи авиабилетов вымышленной авиакомпании.

В [папке](https://github.com/kirillsdnv/vk_chat_bot/tree/master/external_data/dialog) вы найдете диалог с ботом,
охватывающий все шаги сценария и доступные команды.

Общая логика работы чат-бота такова: при запуске
файла [vk_bot.py](https://github.com/kirillsdnv/vk_chat_bot/blob/master/vk_bot.py) объект `VkBotLongPoll` начинает "
слушать" сервер, и при появлении события (`event`) вызывается метод `Bot().event_handler()`. В зависимости от команды
или текста сообщения и того, находится ли пользователь на одном из шагов сценария, вызывается соответствующий метод.

В данном чат-боте доступно 5 команд:

- `'/help'`: отправляет пользователю текст и предлагает воспользоваться командами `'/cities'` и `'/routes'`, чтобы
  узнать об актуальных маршрутах.
- `'/cities'`: выводит список обслуживаемых городов.
- `'/routes'`: дополняет список направлений из каждого города.
- `'/ticket'`: запускает сценарий покупки билета (Ordering).
- `'/restart'`: перезапускает бота.

Все команды обрабатываются методом `commands_handler`. В некоторых случаях для формирования ответа пользователю
используются вспомогательные функции из
модуля [utils.py](https://github.com/kirillsdnv/vk_chat_bot/blob/master/utils.py).

Сценарий Ordering также запускается при наличии ключевого слова-намерения `intent` в тексте сообщения. За это отвечает
метод `Bot().intent_searching()`.

На каждом шаге сценария сообщение от пользователя обрабатывается соответствующим обработчиком (`handler`). Все
функции-обработчики находятся в файле [handlers.py](https://github.com/kirillsdnv/vk_chat_bot/blob/master/handlers.py).
В случае, если данные пользователя корректны, то информация от пользователя заносится в переменную `context`, где
хранятся все данные о заказе: город вылета, город прибытия, время отправления и т.д. В таком случае функция-обработчик
возвращает `True`, текст ответа или клавиатуру. Иначе возвращается `False` и соответствующее сообщение об ошибке. За
обработку результата handler'ов отвечает метод `continue_scenario`.

На последнем шаге сценария Ordering генерируется посадочный талон для пользователя со всеми данными о его полёте. За это
отвечает модуль [generate_ticket.py](https://github.com/kirillsdnv/vk_chat_bot/blob/master/generate_ticket.py) и его
одноимённая функция.
![14](https://user-images.githubusercontent.com/80598880/171870798-a9d28117-62f5-47f0-859e-d75aae9ea893.jpg)

Пример ответа пользователю со сгенерированным билетом.

# Остальные модули

- `config.py` - файл содержащий основные данные для работы бота:
    - переменные окружения из файла `.env`
    - форматы даты и времени, используемые ботом
- `constants.py` - содержит основные используемые ботом константные значения: списки команд и городов, некоторые
  служебные данные
- `wordings.py` - состоит из переменных, содержащих текст сообщений, отправляемых ботом в ходе выполнения сценария
- `scenarios.py` - содержит сценарии для работы с ботом. Каждый сценарий состоит из шагов, которые в свою очередь
  включают в себя:
    - обработчик входящего сообщения
    - тексты сообщения после выполнения обработки
    - имя следующего шага сценария
    - обработчик для генерации билета (на последнем шаге)
- `generate_flights.py` - модуль генерирует расписание и маршруты
- `utils.py` - содержит в себе утилиты различного функционала, обеспечивающие работу с командами, сценарием, датами и
  временем
- `models.py` - отвечает за генерацию баз данных
- `tests.py` - модуль с тестами функционала бота
- `dataset.py` - содержит данные, используемые в тестах: генерирует имитацию сообщений от пользователя и ожидаемые
  ответы бота.
- `keyboards.py` - формирует клавиатуру для выбора вариантов ответа

# Установка и запуск

1. Склонируйте репозиторий на свой компьютер.
2. Установите необходимые зависимости, выполнив команду `pip install -r requirements.txt`.
3. Создайте файл `.env` со следующими переменными окружения:
    - `DB_PASSWORD` - пароль для доступа к базе данных
    - `VK_BOT_TOKEN` - токен доступа к API ВКонтакте
    - `GROUP_ID` - идентификатор группы ВКонтакте
4. Запустите бота командой `python main.py`.
 
